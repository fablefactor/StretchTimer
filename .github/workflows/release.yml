name: Build Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Windows distribution package
        shell: pwsh
        run: |
          # Create dist folder
          New-Item -ItemType Directory -Path dist -Force

          # Copy main application
          Copy-Item stretch_timer.py dist/

          # Create launcher batch file
          @'
          @echo off
          setlocal EnableDelayedExpansion

          title Stretch Timer

          set "SCRIPT_DIR=%~dp0"
          cd /d "%SCRIPT_DIR%" || (
              echo ERROR: Cannot access script directory.
              pause
              exit /b 1
          )

          if not exist "stretch_timer.py" (
              echo ERROR: stretch_timer.py not found.
              pause
              exit /b 1
          )

          :check_python
          set "PYTHON_CMD="

          python --version >nul 2>&1
          if !ERRORLEVEL! equ 0 (
              set "PYTHON_CMD=python"
              goto :python_found
          )

          py --version >nul 2>&1
          if !ERRORLEVEL! equ 0 (
              set "PYTHON_CMD=py"
              goto :python_found
          )

          echo Python not found. Opening installation instructions...

          where powershell >nul 2>&1
          if !ERRORLEVEL! neq 0 (
              echo.
              echo Python Required - Install from Microsoft Store or python.org
              pause
              exit /b 1
          )

          powershell -Command "Add-Type -AssemblyName PresentationFramework; [System.Windows.MessageBox]::Show('Stretch Timer requires Python.`n`nClick OK to open Microsoft Store.`n`nAfter installing, click Recheck.', 'Python Required', 'OK', 'Information')" >nul 2>&1

          start "" "ms-windows-store://pdp/?productid=9NCVDN91XZQP"

          :recheck_dialog
          powershell -Command "Add-Type -AssemblyName PresentationFramework; $result = [System.Windows.MessageBox]::Show('Click OK to recheck for Python.`nClick Cancel to quit.', 'Recheck', 'OKCancel', 'Question'); if ($result -eq 'OK') { exit 0 } else { exit 1 }" >nul 2>&1
          if !ERRORLEVEL! equ 0 (
              goto :check_python
          ) else (
              exit /b 0
          )

          :python_found
          echo Found Python: !PYTHON_CMD!
          echo Checking dependencies...
          !PYTHON_CMD! -m pip install plyer --quiet --disable-pip-version-check >nul 2>&1
          echo Starting Stretch Timer...
          start "" !PYTHON_CMD!w "%SCRIPT_DIR%stretch_timer.py"
          '@ | Out-File -FilePath dist/StretchTimer.bat -Encoding ASCII

          # Create README
          @'
          STRETCH TIMER (Windows)
          =======================

          A desktop app that reminds you to stretch at regular intervals.

          REQUIREMENTS
          ------------
          Python 3.10+ (free from Microsoft Store or python.org)

          HOW TO RUN
          ----------
          Double-click StretchTimer.bat

          If Python is not installed, you'll be guided to install it.
          After installing Python, click "Recheck" to continue.

          FEATURES
          --------
          - Configurable reminder intervals
          - Standing stretches with step-by-step instructions
          - Eye exercises and breathing exercises
          - Light/dark themes
          - Quiet hours
          - Desktop notifications
          - Sound toggle
          - Auto-saved settings

          AUTO-START WITH WINDOWS
          -----------------------
          To have Stretch Timer start automatically when you log in:

          1. Press Win+R to open the Run dialog
          2. Type: shell:startup
          3. Press Enter (opens your Startup folder)
          4. Right-click in the folder and select "New > Shortcut"
          5. Browse to StretchTimer.bat and select it
          6. Name the shortcut "Stretch Timer"

          The app will now start automatically when you log in.
          '@ | Out-File -FilePath dist/README.txt -Encoding ASCII

          # Create ZIP (archive contents of dist, not the folder itself)
          Compress-Archive -Path dist/* -DestinationPath StretchTimer-Windows.zip -Force

          # Show contents
          Write-Host "Created StretchTimer-Windows.zip with contents:"
          Get-ChildItem dist

      - name: Upload Windows release asset
        uses: softprops/action-gh-release@v1
        with:
          files: StretchTimer-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Linux distribution package
        run: |
          # Create dist folder with stretch_timer subdirectory
          mkdir -p dist-linux/stretch_timer

          # Copy main application
          cp stretch_timer.py dist-linux/stretch_timer/

          # Create launcher shell script
          cat > dist-linux/stretch_timer/StretchTimer.sh << 'LAUNCHER_EOF'
          #!/bin/bash
          # ============================================
          # Stretch Timer Launcher
          # ============================================

          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$SCRIPT_DIR" || { echo "ERROR: Cannot access script directory."; exit 1; }

          if [[ ! -f "stretch_timer.py" ]]; then
              echo "ERROR: stretch_timer.py not found."
              exit 1
          fi

          # Check for Python
          PYTHON_CMD=""
          for cmd in python3 python; do
              if command -v "$cmd" &> /dev/null; then
                  PYTHON_CMD="$cmd"
                  break
              fi
          done

          if [[ -z "$PYTHON_CMD" ]]; then
              echo ""
              echo "Python not found. Please install Python 3.10+:"
              echo ""
              echo "  Ubuntu/Debian: sudo apt install python3 python3-tk python3-pip"
              echo "  Fedora:        sudo dnf install python3 python3-tkinter python3-pip"
              echo "  Arch:          sudo pacman -S python python-tkinter python-pip"
              echo ""
              exit 1
          fi

          echo "Found Python: $PYTHON_CMD"
          echo "Checking dependencies..."

          # Check for tkinter
          if ! $PYTHON_CMD -c "import tkinter" 2>/dev/null; then
              echo ""
              echo "ERROR: tkinter is not installed."
              echo ""
              echo "Please install tkinter for your distribution:"
              echo ""
              echo "  Ubuntu/Debian: sudo apt install python3-tk"
              echo "  Fedora:        sudo dnf install python3-tkinter"
              echo "  Arch:          sudo pacman -S tk"
              echo ""
              exit 1
          fi

          # Install plyer (optional, for notifications)
          $PYTHON_CMD -m pip install plyer --quiet --user 2>/dev/null || true

          echo "Starting Stretch Timer..."
          $PYTHON_CMD "$SCRIPT_DIR/stretch_timer.py" &
          LAUNCHER_EOF

          chmod +x dist-linux/stretch_timer/StretchTimer.sh

          # Create README
          cat > dist-linux/stretch_timer/README.txt << 'README_EOF'
          STRETCH TIMER (Linux)
          =====================

          A desktop app that reminds you to stretch at regular intervals.

          REQUIREMENTS
          ------------
          Python 3.10+ with tkinter

          Install on Ubuntu/Debian:
            sudo apt install python3 python3-tk python3-pip

          Install on Fedora:
            sudo dnf install python3 python3-tkinter python3-pip

          Install on Arch:
            sudo pacman -S python python-tkinter python-pip

          HOW TO RUN
          ----------
          1. Open a terminal in this folder
          2. Run: ./StretchTimer.sh

          Or run directly:
            python3 stretch_timer.py

          FEATURES
          --------
          - Configurable reminder intervals
          - Standing stretches with step-by-step instructions
          - Eye exercises and breathing exercises
          - Light/dark themes
          - Quiet hours
          - Desktop notifications
          - Sound toggle
          - Auto-saved settings

          AUTO-START (GNOME/KDE)
          ----------------------
          To have Stretch Timer start automatically when you log in:

          GNOME (using Startup Applications):
          1. Open "Startup Applications" (gnome-session-properties)
          2. Click "Add"
          3. Name: Stretch Timer
          4. Command: /full/path/to/StretchTimer.sh
          5. Click "Add"

          KDE:
          1. Open System Settings > Startup and Shutdown > Autostart
          2. Click "Add Script"
          3. Browse to StretchTimer.sh

          Using .desktop file (works on most desktops):
          1. Create ~/.config/autostart/stretchtimer.desktop with:

          [Desktop Entry]
          Type=Application
          Name=Stretch Timer
          Exec=/full/path/to/StretchTimer.sh
          Hidden=false
          NoDisplay=false
          X-GNOME-Autostart-enabled=true
          README_EOF

          # Create tar.gz archive (includes stretch_timer/ subdirectory)
          tar -czf stretch_timer-linux.tar.gz -C dist-linux stretch_timer

          # Show contents
          echo "Created stretch_timer-linux.tar.gz with contents:"
          ls -la dist-linux/stretch_timer/

      - name: Upload Linux release asset
        uses: softprops/action-gh-release@v1
        with:
          files: stretch_timer-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
